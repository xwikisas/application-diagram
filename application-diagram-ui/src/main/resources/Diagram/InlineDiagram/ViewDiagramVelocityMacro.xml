<?xml version="1.1" encoding="UTF-8"?>

<!--
 * See the NOTICE file distributed with this work for additional
 * information regarding copyright ownership.
 *
 * This is free software; you can redistribute it and/or modify it
 * under the terms of the GNU Lesser General Public License as
 * published by the Free Software Foundation; either version 2.1 of
 * the License, or (at your option) any later version.
 *
 * This software is distributed in the hope that it will be useful,
 * but WITHOUT ANY WARRANTY; without even the implied warranty of
 * MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE. See the GNU
 * Lesser General Public License for more details.
 *
 * You should have received a copy of the GNU Lesser General Public
 * License along with this software; if not, write to the Free
 * Software Foundation, Inc., 51 Franklin St, Fifth Floor, Boston, MA
 * 02110-1301 USA, or see the FSF site: http://www.fsf.org.
-->

<xwikidoc version="1.5" reference="Diagram.InlineDiagram.ViewDiagramVelocityMacro" locale="">
  <web>Diagram.InlineDiagram</web>
  <name>ViewDiagramVelocityMacro</name>
  <language/>
  <defaultLanguage/>
  <translation>0</translation>
  <creator>xwiki:XWiki.Admin</creator>
  <parent>Diagram.InlineDiagram.InlineDiagramMacro</parent>
  <author>xwiki:XWiki.Admin</author>
  <contentAuthor>xwiki:XWiki.Admin</contentAuthor>
  <version>1.1</version>
  <title>ViewDiagramVelocityMacro</title>
  <comment/>
  <minorEdit>false</minorEdit>
  <syntaxId>xwiki/2.1</syntaxId>
  <hidden>true</hidden>
  <content>
{{velocity}}
## Configuration for the inline diagram macro suite. This is used as default if the 
## user doesn't specify a configuration.
#set ($defaultConfig = {
  "debug": $services.debug.minify.equals(false),
  "locale": $xcontext.locale,
  "drawIOBasePath": $services.webjars.url('org.xwiki.contrib:draw.io', ''),
  "exportURL": $xwiki.getDocument('Diagram.DiagramConfig').getValue('exportURL'),
  "pdfImageExportZoom": 0,
  "disableExternalServices": $xwiki.getDocument('Diagram.DiagramConfig').getValue('disableExternalServices'),
  "isTemporaryUploadSupported": $temporaryUploadSupported
})

##
## Displays the diagram.
## @param diagramName the name of the diagram, used for the title.
## @param returnFragment the fragment to which the editor should return after saving the diagram.
## @param diagramConfig the configuration of the diagram, used to initialize the diagram editor.
## @param diagramToolbar the configuration of the diagram toolbar, used to in view mode to display the toolbar.
## @param diagramContent the content of the diagram.
## @param sourceDocumentReference used to identify the source document of the diagram, used by the editor to know
## where to save this diagram.
## @param returnDocumentReference used to identify the document to which the editor should return after saving.
##
#macro (displayDiagram $diagramName, $returnFragment, $diagramConfig, $diagramToolbar, $diagramContent, $sourceDocumentReference, $returnDocumentReference, $extraCSSClass)
  #if("$!diagramConfig" == "")
    #set ($diagramConfig = $defaultConfig)
  #end

  {{html}}
    &lt;div 
      id = "$returnFragment"
      class = "diagram $extraCSSClass"
      data-diagram-config = "$escapetool.xml($jsontool.serialize($diagramConfig))"
      data-toolbar = "$escapetool.xml($diagramToolbar)"
      data-model = "$escapetool.xml($diagramContent)"
      data-title = "$escapetool.xml($diagramName)"
      data-reference="$sourceDocumentReference"
      data-source-document-reference = "$sourceDocumentReference"
      data-return-document-reference = "$returnDocumentReference"
      data-return-fragment = "$returnFragment"
    &gt;
      ## After the editor is done loading the diagram it cleans the items that were present in the parent div.
      &lt;div class = "loading"&gt; &lt;/div&gt;
    &lt;/div&gt;
  {{/html}}

#end

##
## Sets the $content variable with the content of the diagram. The content is read from
## the current document if the document parameter is an empty string, otherwise it is read
## from the specified document.
##
## @param document the document from which the diagram content should be read. If empty then the current document is used.
## @param diagramName the name of the diagram, used to find the attachment containing the diagram.
##
#macro (getDiagramContent $document, $diagramName)
  #set ($diagramDocument = "")
  #if ($document == "")
    #set ($diagramDocument = $doc)
  #else
    #set ($diagramDocument = $xwiki.getDocument($document))
  #end
  #set ($attachmentName = "${diagramName}.diagram.xml")
  #set ($attachment = $diagramDocument.getAttachment($attachmentName))
  #set ($content = "$!attachment.getContentAsString()")
#end

{{/velocity}}
</content>
</xwikidoc>
